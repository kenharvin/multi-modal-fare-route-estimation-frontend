name: Android APK Build

on:
  push:
  workflow_dispatch:

concurrency:
  group: android-apk-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  build-apk:
    runs-on: ubuntu-latest
    env:
      EXPO_PUBLIC_BACKEND_TARGET: deployed
      EXPO_PUBLIC_API_BASE_URL_DEPLOYED: https://navigo.ildf.site
      EXPO_PUBLIC_API_BASE_URL: https://navigo.ildf.site
      EXPO_PUBLIC_OPENSTREETMAP_API_URL: https://nominatim.openstreetmap.org
      EXPO_PUBLIC_API_KEY: ${{ secrets.EXPO_PUBLIC_API_KEY }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Install dependencies
        run: npm ci

      - name: Generate Android project
        run: npx expo prebuild --platform android --non-interactive --no-install

      - name: Build APK (release, ARM64 only)
        working-directory: android
        run: ./gradlew assembleRelease -PreactNativeArchitectures=arm64-v8a

      - name: Resolve app version
        id: appmeta
        run: |
          set -euo pipefail
          VERSION="$(node -p "require('./app.json').expo.version")"
          APK_FILENAME="navigo-v${VERSION}.apk"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "apk_filename=$APK_FILENAME" >> "$GITHUB_OUTPUT"

      - name: Resolve APK path
        id: apk
        run: |
          set -euo pipefail
          APK_PATH="$(ls -1 android/app/build/outputs/apk/release/*.apk | head -n 1)"
          echo "apk_path=$APK_PATH" >> "$GITHUB_OUTPUT"

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: navigo-v${{ steps.appmeta.outputs.version }}-apk
          path: ${{ steps.apk.outputs.apk_path }}
          if-no-files-found: error

      - name: Publish latest respondent release
        id: publish_release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          TAG="respondent-latest"
          TITLE="Respondent APK (Latest)"
          NOTES="Latest release APK for respondents from workflow run #${{ github.run_number }} (v${{ steps.appmeta.outputs.version }})."
          APK_PATH="${{ steps.apk.outputs.apk_path }}"
          APK_FILENAME="${{ steps.appmeta.outputs.apk_filename }}"

          if gh release view "$TAG" >/dev/null 2>&1; then
            gh release upload "$TAG" "$APK_PATH#$APK_FILENAME" --clobber
            gh release edit "$TAG" --title "$TITLE" --notes "$NOTES"
          else
            gh release create "$TAG" "$APK_PATH#$APK_FILENAME" --title "$TITLE" --notes "$NOTES"
          fi

          RELEASE_URL="$(gh release view "$TAG" --json url --jq .url)"
          echo "release_url=$RELEASE_URL" >> "$GITHUB_OUTPUT"

      - name: Add release link to job summary
        run: |
          echo "## Respondent Download Link" >> "$GITHUB_STEP_SUMMARY"
          echo "${{ steps.publish_release.outputs.release_url }}" >> "$GITHUB_STEP_SUMMARY"
